<!DOCTYPE html>
<html>
<head>
    <title>基金数据</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .header {
            background-color: #f8f9fa;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        .selected-row {
            background-color: #e2f0ff !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h2>基金数据查询</h2>
                </div>
                <!-- 在更新数据按钮前添加输入框 -->
                <div class="col-md-6 text-end">
                    <div class="input-group mb-2">
                        <span class="input-group-text">数据条数</span>
                        <input type="number" id="maxItems" class="form-control" value="15000" min="1" max="50000">
                        <span class="input-group-text">翻页次数</span>
                        <input type="number" id="maxPages" class="form-control" value="1" min="1" max="10">
                    </div>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addFundModal">
                        <i class="bi bi-plus-circle"></i> 新增基金
                    </button>
                    <a href="/analysis" class="btn btn-info me-2">
                        <i class="bi bi-bar-chart-fill"></i> 数据分析
                    </a>
                    <a href="/prediction" class="btn btn-success me-2">
                        <i class="bi bi-graph-up"></i> 趋势预测
                    </a>
                    <button class="btn btn-primary" onclick="updateData()">
                        <i class="bi bi-arrow-repeat"></i> 更新数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-3">
            <div class="col-md-8">
                <form class="d-flex" method="GET">
                    <input class="form-control me-2" type="search" name="search" placeholder="输入基金代码或名称">
                    <button class="btn btn-outline-primary" type="submit">搜索</button>
                </form>
            </div>
            <!-- 在批量删除按钮旁边添加导出CSV按钮 -->
            <!-- 在导出CSV按钮旁边添加删除所有数据按钮 -->
            <div class="col-md-4 text-end">
                <button id="batchDeleteBtn" class="btn btn-danger me-2" onclick="batchDelete()" disabled>
                    <i class="bi bi-trash"></i> 批量删除
                </button>
                <button class="btn btn-success me-2" onclick="exportAllToCSV()">
                    <i class="bi bi-file-earmark-excel"></i> 导出CSV
                </button>
                <button class="btn btn-danger" onclick="deleteAllFunds()">
                    <i class="bi bi-trash-fill"></i> 删除所有
                </button>
            </div>
        </div>

        <div id="loading" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p>数据加载中，请稍候...</p>
        </div>

        <div id="fundTable">
            <!-- 基金数据表格将通过JavaScript加载 -->
        </div>
        
        <div id="pagination" class="mt-4">
            <!-- 分页控件将通过JavaScript加载 -->
        </div>
    </div>

    <script>
        // 全局变量
        let allFunds = []; // 所有基金数据
        let currentPage = 1; // 当前页码
        const pageSize = 100; // 每页显示数量
        let selectedFunds = []; // 已选择的基金代码
        
        // 页面加载时获取基金数据
        document.addEventListener('DOMContentLoaded', function() {
            fetchFunds();
        });

        // 获取基金数据
        function fetchFunds() {
            document.getElementById('loading').classList.remove('d-none');
            
            const searchParams = new URLSearchParams(window.location.search);
            const searchTerm = searchParams.get('search') || '';
            
            fetch(`/api/funds?search=${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    allFunds = data.funds || [];
                    renderFundTable();
                    renderPagination();
                    document.getElementById('loading').classList.add('d-none');
                })
                .catch(error => {
                    console.error('获取基金数据失败:', error);
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('fundTable').innerHTML = '<div class="alert alert-danger">获取数据失败，请稍后再试</div>';
                });
        }

        // 更新基金数据
        function updateData() {
            if (!confirm('确定要更新基金数据吗？这可能需要一些时间。')) {
                return;
            }
            
            // 获取用户输入的参数
            const maxItems = document.getElementById('maxItems').value;
            const maxPages = document.getElementById('maxPages').value;
            
            document.getElementById('loading').classList.remove('d-none');
            
            fetch(`/api/update?max_items=${maxItems}&max_pages=${maxPages}`)
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    fetchFunds();
                })
                .catch(error => {
                    console.error('更新基金数据失败:', error);
                    document.getElementById('loading').classList.add('d-none');
                    alert('更新数据失败，请稍后再试');
                });
        }

        // 渲染基金数据表格
        function renderFundTable() {
            if (!allFunds || allFunds.length === 0) {
                document.getElementById('fundTable').innerHTML = '<div class="alert alert-info">没有找到基金数据</div>';
                return;
            }
            
            // 计算当前页的数据
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, allFunds.length);
            const currentPageData = allFunds.slice(startIndex, endIndex);
            
            let tableHtml = `
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>基金代码</th>
                            <th>基金名称</th>
                            <th>最新净值</th>
                            <th>累计净值</th>
                            <th>日增长值</th>
                            <th>日增长率</th>
                            <th>更新日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentPageData.forEach(fund => {
                const isSelected = selectedFunds.includes(fund.fund_code);
                tableHtml += `
                    <tr class="${isSelected ? 'selected-row' : ''}">
                        <td>
                            <input type="checkbox" class="fund-checkbox" value="${fund.fund_code}" 
                                ${isSelected ? 'checked' : ''} onchange="toggleFundSelection('${fund.fund_code}')">
                        </td>
                        <td>${fund.fund_code}</td>
                        <td>${fund.fund_name}</td>
                        <td>${fund.latest_net_value}</td>
                        <td>${fund.latest_total_value}</td>
                        <td>${fund.daily_growth_value}</td>
                        <td>${fund.daily_growth_rate}%</td>
                        <td>${fund.latest_date}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openEditModal('${fund.fund_code}')">
                                <i class="bi bi-pencil"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="openDeleteModal('${fund.fund_code}', '${fund.fund_name}')">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('fundTable').innerHTML = tableHtml;
            updateBatchDeleteButton();
        }
        
        // 渲染分页控件
        function renderPagination() {
            if (!allFunds || allFunds.length === 0) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(allFunds.length / pageSize);
            
            let paginationHtml = `
                <nav aria-label="基金数据分页">
                    <ul class="pagination">
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage - 1})" aria-label="上一页">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
            `;
            
            // 显示页码
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || // 第一页
                    i === totalPages || // 最后一页
                    (i >= currentPage - 2 && i <= currentPage + 2) // 当前页附近的页码
                ) {
                    paginationHtml += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (
                    (i === currentPage - 3 && currentPage > 3) || 
                    (i === currentPage + 3 && currentPage < totalPages - 2)
                ) {
                    // 添加省略号
                    paginationHtml += `
                        <li class="page-item disabled">
                            <a class="page-link" href="javascript:void(0)">...</a>
                        </li>
                    `;
                }
            }
            
            paginationHtml += `
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage + 1})" aria-label="下一页">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            `;
            
            document.getElementById('pagination').innerHTML = paginationHtml;
        }
        
        // 切换页码
        function changePage(page) {
            if (page < 1 || page > Math.ceil(allFunds.length / pageSize)) {
                return;
            }
            
            currentPage = page;
            renderFundTable();
            renderPagination();
        }
        
        // 切换全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.fund-checkbox');
            
            if (selectAllCheckbox.checked) {
                // 全选
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    if (!selectedFunds.includes(checkbox.value)) {
                        selectedFunds.push(checkbox.value);
                    }
                });
            } else {
                // 取消全选
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const index = selectedFunds.indexOf(checkbox.value);
                    if (index !== -1) {
                        selectedFunds.splice(index, 1);
                    }
                });
            }
            
            renderFundTable();
            updateBatchDeleteButton();
        }
        
        // 切换单个基金选择
        function toggleFundSelection(fundCode) {
            const index = selectedFunds.indexOf(fundCode);
            
            if (index === -1) {
                // 添加到选中列表
                selectedFunds.push(fundCode);
            } else {
                // 从选中列表移除
                selectedFunds.splice(index, 1);
            }
            
            renderFundTable();
            updateBatchDeleteButton();
        }
        
        // 更新批量删除按钮状态
        function updateBatchDeleteButton() {
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            batchDeleteBtn.disabled = selectedFunds.length === 0;
        }
        
        // 批量删除
        function batchDelete() {
            if (selectedFunds.length === 0) {
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedFunds.length} 个基金吗？此操作不可恢复。`)) {
                return;
            }
            
            document.getElementById('loading').classList.remove('d-none');
            
            fetch('/api/funds/batch-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fund_codes: selectedFunds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`成功删除 ${data.deleted_count} 个基金`);
                    selectedFunds = [];
                    fetchFunds();
                } else {
                    alert('删除失败: ' + data.message);
                    document.getElementById('loading').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('批量删除失败:', error);
                document.getElementById('loading').classList.add('d-none');
                alert('批量删除失败，请稍后再试');
            });
        }

        // 导出所有基金数据为CSV
        function exportAllToCSV() {
            document.getElementById('loading').classList.remove('d-none');
            
            fetch('/api/funds/export-csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('导出失败');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // 使用当前日期作为文件名
                    const date = new Date();
                    const fileName = `fund_data_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}.csv`;
                    a.download = fileName;
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.getElementById('loading').classList.add('d-none');
                })
                .catch(error => {
                    console.error('导出CSV失败:', error);
                    document.getElementById('loading').classList.add('d-none');
                    alert('导出CSV失败，请稍后再试');
                });
        }
        
        // 删除所有基金数据
        function deleteAllFunds() {
            if (!confirm('警告：此操作将删除所有基金数据且无法恢复，确定要继续吗？')) {
                return;
            }
            
            document.getElementById('loading').classList.remove('d-none');
            
            fetch('/api/funds/delete-all', {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`成功删除所有基金数据：共${data.count}条记录`);
                    // 刷新数据
                    fetchFunds();
                } else {
                    alert(`删除失败：${data.message}`);
                }
                document.getElementById('loading').classList.add('d-none');
            })
            .catch(error => {
                console.error('删除所有数据失败:', error);
                document.getElementById('loading').classList.add('d-none');
                alert('删除所有数据失败，请稍后再试');
            });
        }
    </script>

    <!-- 保留现有的模态框和其他代码 -->
    <!-- ... existing code ... -->